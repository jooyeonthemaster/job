'use client';

import { useState } from 'react';
import { 
  OnboardingStep1,
  validateBusinessNumber,
  validateEmail,
  validatePhone 
} from '@/lib/firebase/company-types';
import { 
  saveOnboardingStep1,
  checkBusinessNumberDuplicate 
} from '@/lib/firebase/company-service';
import { Building2, Calendar, Users, Phone, Globe } from 'lucide-react';

interface Props {
  data: OnboardingStep1 | null;
  onSave: (data: OnboardingStep1) => void;
  uid: string;
}

const industries = [
  'Technology', 'Internet', 'E-commerce', 'Fintech', 
  'Healthcare', 'Education', 'Manufacturing', 'Retail',
  'Food & Beverage', 'Gaming', 'Media', 'Transportation'
];

const employeeCounts = [
  '1-10ëª…', '11-50ëª…', '51-100ëª…', '101-300ëª…',
  '301-1,000ëª…', '1,001-5,000ëª…', '5,000ëª… ì´ìƒ'
];
export default function Step1BasicInfo({ data, onSave, uid }: Props) {
  const [formData, setFormData] = useState<OnboardingStep1>(data || {
    name: '',
    nameEn: '',
    registrationNumber: '',
    ceoName: '',
    established: '',
    industry: '',
    employeeCount: '',
    phone: '',
    website: ''
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [loading, setLoading] = useState(false);

  const validateForm = async () => {
    const newErrors: Record<string, string> = {};
    
    if (!formData.name) newErrors.name = 'íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
    if (!formData.nameEn) newErrors.nameEn = 'ì˜ë¬¸ íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
    if (!formData.registrationNumber) {
      newErrors.registrationNumber = 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
    } else if (formData.registrationNumber.length !== 10) {
      newErrors.registrationNumber = '10ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
    } else if (!/^\d{10}$/.test(formData.registrationNumber)) {
      newErrors.registrationNumber = 'ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤';
    } else {
      const isDuplicate = await checkBusinessNumberDuplicate(formData.registrationNumber, uid);
      if (isDuplicate) {
        newErrors.registrationNumber = 'ì´ë¯¸ ë“±ë¡ëœ ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ì…ë‹ˆë‹¤';
      }
    }
    if (!formData.ceoName) newErrors.ceoName = 'ëŒ€í‘œìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
    if (!formData.established) newErrors.established = 'ì„¤ë¦½ë…„ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
    if (!formData.industry) newErrors.industry = 'ì‚°ì—…êµ°ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
    if (!formData.employeeCount) newErrors.employeeCount = 'ì§ì›ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
    if (!formData.phone) {
      newErrors.phone = 'ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
    } else if (!validatePhone(formData.phone)) {
      newErrors.phone = 'ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 02-1234-5678)';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!await validateForm()) return;
    
    try {
      setLoading(true);
      await saveOnboardingStep1(uid, formData);
      onSave(formData);
    } catch (error) {
      console.error('Error saving step 1:', error);
      setErrors({ submit: 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (field: keyof OnboardingStep1, value: string) => {
    // ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥ (10ìë¦¬)
    if (field === 'registrationNumber') {
      const numbersOnly = value.replace(/[^0-9]/g, '');
      if (numbersOnly.length <= 10) {
        setFormData(prev => ({ ...prev, [field]: numbersOnly }));
      }
    } else {
      setFormData(prev => ({ ...prev, [field]: value }));
    }
    setErrors(prev => ({ ...prev, [field]: '' }));
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-gray-900 mb-2">ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
        <p className="text-gray-600">íšŒì‚¬ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
      </div>

      <div className="grid lg:grid-cols-2 gap-6">
        {/* íšŒì‚¬ëª… (í•œê¸€) */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            íšŒì‚¬ëª… <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={formData.name}
            onChange={(e) => handleChange('name', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.name ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="ì˜ˆ: ì‚¼ì„±ì „ì"
          />
          {errors.name && <p className="mt-1 text-sm text-red-500">{errors.name}</p>}
        </div>
        {/* íšŒì‚¬ëª… (ì˜ë¬¸) */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            íšŒì‚¬ëª… (ì˜ë¬¸) <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={formData.nameEn}
            onChange={(e) => handleChange('nameEn', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.nameEn ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="ì˜ˆ: Samsung Electronics"
          />
          {errors.nameEn && <p className="mt-1 text-sm text-red-500">{errors.nameEn}</p>}
        </div>

        {/* ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            inputMode="numeric"
            value={formData.registrationNumber}
            onChange={(e) => handleChange('registrationNumber', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.registrationNumber ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="1234567890"
            maxLength={10}
          />
          {errors.registrationNumber && <p className="mt-1 text-sm text-red-500">{errors.registrationNumber}</p>}
          <p className="mt-1 text-xs text-gray-500">ğŸ’¡ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥ (í•˜ì´í”ˆ ì—†ì´ 10ìë¦¬) {formData.registrationNumber.length}/10</p>
        </div>
        {/* ëŒ€í‘œìëª… */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ëŒ€í‘œìëª… <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={formData.ceoName}
            onChange={(e) => handleChange('ceoName', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.ceoName ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="ì˜ˆ: ê¹€ì² ìˆ˜"
          />
          {errors.ceoName && <p className="mt-1 text-sm text-red-500">{errors.ceoName}</p>}
        </div>

        {/* ì„¤ë¦½ë…„ë„ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ì„¤ë¦½ë…„ë„ <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={formData.established}
            onChange={(e) => handleChange('established', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.established ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="ì˜ˆ: 2015"
          />
          {errors.established && <p className="mt-1 text-sm text-red-500">{errors.established}</p>}
        </div>
        {/* ì‚°ì—…êµ° */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ì‚°ì—…êµ° <span className="text-red-500">*</span>
          </label>
          <select
            value={formData.industry}
            onChange={(e) => handleChange('industry', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.industry ? 'border-red-500' : 'border-gray-300'}`}
          >
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            {industries.map(industry => (
              <option key={industry} value={industry}>{industry}</option>
            ))}
          </select>
          {errors.industry && <p className="mt-1 text-sm text-red-500">{errors.industry}</p>}
        </div>

        {/* ì§ì›ìˆ˜ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ì§ì›ìˆ˜ <span className="text-red-500">*</span>
          </label>
          <select
            value={formData.employeeCount}
            onChange={(e) => handleChange('employeeCount', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.employeeCount ? 'border-red-500' : 'border-gray-300'}`}
          >
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            {employeeCounts.map(count => (
              <option key={count} value={count}>{count}</option>
            ))}
          </select>
          {errors.employeeCount && <p className="mt-1 text-sm text-red-500">{errors.employeeCount}</p>}
        </div>
        {/* ì „í™”ë²ˆí˜¸ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ëŒ€í‘œ ì „í™”ë²ˆí˜¸ <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={formData.phone}
            onChange={(e) => handleChange('phone', e.target.value)}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent
              ${errors.phone ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="02-1234-5678"
          />
          {errors.phone && <p className="mt-1 text-sm text-red-500">{errors.phone}</p>}
        </div>

        {/* ì›¹ì‚¬ì´íŠ¸ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ì›¹ì‚¬ì´íŠ¸
          </label>
          <input
            type="url"
            value={formData.website || ''}
            onChange={(e) => handleChange('website', e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            placeholder="https://example.com"
          />
        </div>
      </div>

      {errors.submit && (
        <div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
          {errors.submit}
        </div>
      )}

      <div className="flex justify-end">
        <button
          type="submit"
          disabled={loading}
          className="px-8 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {loading ? 'ì €ì¥ì¤‘...' : 'ë‹¤ìŒ ë‹¨ê³„ë¡œ'}
        </button>
      </div>
    </form>
  );
}